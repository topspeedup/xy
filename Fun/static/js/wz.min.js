 
var nick='',data=null,wenanOldTitle=null,wenanIntro=null,wenanImg='',getjsInfo=false;
var laytpl=null,form=null,layer=null;
layui.use(['laytpl','layer','form'], function(){  //如果只加载一个组件，可以不填数组。如：layui.use('form')
	 laytpl = layui.laytpl;
	 layer = layui.layer;
	 form  = layui.form();
});
function changeTpl(){
	  console.log("change");
	  var arr=[],count=0;
      $("#color_upload,#tuiguangImg,#shorttitle,#price,#coupon_price,#coupons,#couponslink,#clickurl,#guide_article").each(function(i,v){
          var o=$(this),name=o.attr("id");
          name && (arr[count++]="'"+name+"':'"+o.val()+"'");
      });
      arr="{"+arr.join(',')+"}";
      data=eval('(' + arr + ')');
      console.log(data);
      laytpl($("#yltpl").html()).render(data, function (html) {
          $("#yulan").html(html);
      });
}
$(function(){
	$("body").on("paste",function(e) {
		if(e.target.id=='wx_wxcontent'){
			 var wx_wxcontent=$("#wx_wxcontent");
		        if(wx_wxcontent.length>0){
		        	setTimeout(function(){
		        		var src=wx_wxcontent.find('img').attr('src');
		        		if(src.indexOf("http")>=0)wenanImg=src;
		        		
//		        		$("#copyimage").val(src);
//		        		$("#tuiguangImg").attr('src',src).parent('.hide').removeClass('hide');
		        		var txt=wx_wxcontent.text();
		        		var html=wx_wxcontent.children(":not(br,img)");
		        		var imgreg=/<img/gmi;
		        		var itemlinkreg=/http[s]{0,1}:\/\/[(item.taobao.com)(detail.tmall.com)][a-zA-z=\?0-9_&\.\/%$#@:]+/gmi;
		        		var yhjlink=/http[s]{0,1}:\/\/.*?\.taobao\.com\/.*?coupon.*?\?[a-z\d\?_\=\&\%A-Z\+\.-]*/gmi;
		        		$("#clickurl").val(txt.match(itemlinkreg)[0]);
		        		$("#couponslink").val(txt.match(yhjlink)[0]);
		        		html.each(function(i,v){
		        			var t=$(v).text();
		        			var reg = /http[s]{0,1}/gm,reg2 = /\d+/gm;
		        			if(!reg.test(t)&&!(t.indexOf("元")>0&&reg2.test(t))){
		        				console.log(t)
		        				console.log(new RegExp("/[\u4e00-\u9fa5\s]{8,20}/g").test(t))
		        				if(!wenanOldTitle&&new RegExp("/[\u4e00-\u9fa5]{8,20}/gm").test(t))wenanOldTitle=t;
		        				else if(wenanOldTitle&&new RegExp("/[\u4e00-\u9fa5]{15,200}/gm").test(t))wenanOldIntro=t;
		        			}
		        		});
		        		
		        		getitemdesc(1);
		        		
		        	},200);
		        }
		}
       
    })
  $("#wx_wxcontent").on('click',function(){
	  $(this).find('h3').remove();
  }); 
 
	    $("input").change(function(){
	    	changeTpl();
	    });
	 
	$("#selectArr").on("change",".category",function(){
		var o=$(this);
		if(!o.val()){
			o.nextAll("select").remove();
			return;
		}
		$.get("/index/index/ajaxGetCate.html",{id:o.val()},function(d){
			o.nextAll("select").remove();
			$(d).insertAfter(o);
		});
	});
    //解析下单链接
    //-------------------------------------------------------------------
	var quanOld=0;
   var clickurl= $('#clickurl').on('input',function(){
	   getitemdesc(0);
    });
function getitemdesc(autoyhq){
	  var order_address=$.trim($("#clickurl").val());
      var preg=/https:\/\/[(item.taobao.com)(detail.tmall.com)][a-zA-z=\?0-9_&\.\/%$#@:]+/gmi;
      var preg_number=/^\+?[1-9][0-9]{3,}$/;
      var v=clickurl.val();
      if(v.indexOf("https")<0)v=v.replace("http","https");
		var yz=preg.exec(v.trim());
		if(yz){
			  var idreg=/\d{9,12}/,id=idreg.exec(v);
			  var itemid=id[0],isau=null;
			  var index = layer.load(0, {shade: false}); //0代表加载的风格，支持0-2
            //查询是否发布过或者宝贝被拉黑
            $.getJSON('http://a.yishoudan.com/index.php?callback=?&m=itemsf&a=ajaxGetItem',{link:v},function(r){
                nick = '';
            	layer.close(index);
            	if(r.status == 1||r.status == -1){
            		
            		 var data=r.data;
            		if(data.ldmsg){
            			var conf=confirm(data.ldmsg+",如果继续上架请选择【上架时间】为您的【佣金生效时间】，提前于【佣金生效时间】上架会被【下架】！");
            			if(!conf){
            				clickurl.val('');
                			return ;
            			}
            			getjsInfo=true;
            			$("#showTime label:eq(1)").click();
            		}
            		
            		 console.log(data);
                     if(nick!=''){
                 		if(nick!=data.sellerId){
                 			layer.msg("宝贝店铺名和优惠券店铺名不相符",{time: 3000, icon:3});
                 			clickurl.val('');
                 			return;
                 		}
                 	}else{
                 		nick=data.sellerId;
                 		console.log(nick);
                 	}
                     isau=data.isau;
                     getjsInfo||setItemInfo(data);
                     if(autoyhq==1)getyhqdesc();
                 }else{
                	 layer.msg(r.info,{time: 3000, icon:3});
                    clickurl.val('');
                 }
            	jiance();
				});
          function jiance(){
        	  $.getJSON('https://hws.m.taobao.com/cache/wdetail/5.0/?callback=?',{id:itemid},function(r){
              	  console.log(r);
                  	if(r.ret[0] == "SUCCESS::调用成功"){
                  		var status=["<img src='http://a.yishoudan.com/static/images/admin/toggle_enabled.gif' >","<img src='http://a.yishoudan.com/static/images/admin/toggle_disabled.gif' >"];
                		var txt='', str='<table class="shenhe"><thead><tr><th width="70">栏目</th><th width="200">当前值</th><th width="200">要求值</th><th width="50">是否达标</th></tr></thead><tbody>';
            			var tmsg="无敏感词",stmsg="无敏感词",terror=status[0],sterror=status[0],mgcstr='',stitlemg='';
            			var d=r.data;
            			var shop=d.seller,volume=0;
            			//检查月销量
            			
            		 	var score=d.seller.evaluateInfo,commentCount=d.rateInfo.rateCounts;
                  		
                  		if(r.data){
                  			 var data=r.data;
                  			 if(data.trackParams){
                  				 $("#catetwo_id").val(data.trackParams.categoryId);
                  			 }
                  			 if(data.apiStack){
            						var v=data.apiStack[0].value;
            							if(v){
            								v=JSON.parse(v);
            								if(v){
            									$("#kucun").val(v.data.itemInfoModel.quantity);
            									
            									if(isziji!=2||1==1){
            									var err=false;
            									//第二个接口配合 获取评分
            									$.ajax({url:"https://unszacs.m.taobao.com/h5/mtop.taobao.detail.getdetail/6.0/?callback=?&appKey=12574478&t=1504172532577&sign=a81b059cb50f3a2437040777bf876af0&api=mtop.taobao.detail.getdetail&v=6.0&ttid=2016%40taobao_h5_2.0.0&isSec=0&ecode=0&AntiFlood=true&AntiCreep=true&H5Request=true&data=%7B%22exParams%22%3A%22%7B%5C%22id%5C%22%3A%5C%22"+itemid+"%5C%22%7D%22%2C%22itemNumId%22%3A%22"+itemid+"%22%7D",
            						                dataType:'jsonp',
            						                success:function(result) {
            						                    if(result.ret[0] == "SUCCESS::调用成功"){
            						                    	console.log(result);
            						                    	if(result.data.apiStack){
            						          					var val=JSON.parse(result.data.apiStack[0].value);
            						          					if(val){
            						          						volume=val.item.sellCount;
            						          						//if(volume<10)err=true;
            						          						$("#volume").val(volume);
            						          						$("#initVolume").val(volume);
            						          						str+="<tr><th>月销量</th><td>"+volume+"</td><td>单品月销量≥10</td><td align='center'>"+((volume>=10)?status[0]:status[1])+"</td></tr>";
            						          					}
            						          			 	}
            						                       var seller=result.data.seller;
            						                       if(seller.shopType=='C'&&seller.creditLevel<9){
            						                    	   //err=true;
            						                    	   str+="<tr><th>C店等级</th><td>"+seller.creditLevel+"</td><td>C店等级≥9【最低4钻】</td><td align='center'>"+status[1]+"</td></tr>";
            						                       }
            						                       if(commentCount<5&&1!=1){
            						                    	   //err=true;
            						                    	   str+="<tr><th>累计评价</th><td>"+commentCount+"</td><td>累计评价≥5</td><td align='center'>"+status[1]+"</td></tr>";
            						                       }
            						                       var evaluates=seller.evaluates;
            						                       
            						                       var level=["<i class='shenhe-green'>↓</i>","<i class='shenhe-orange'>一</i>","<i class='shenhe-red'>↑</i>"];
            						                       var level_text=["低于","持平","高于"];
            						                       var lanmu='<th rowspan="3">评分</th>';
            						                       var msg=["符合","符合","符合"],error=[status[0],status[0],status[0]];
            						                       /*天猫动态评分≥4.6时，
            						                       ??a、描述分低于同行1.8%时，一律不能提交；
            						                       ??b、描述分低于同行1.2%时，销量必须≥300；
            						                       ??c、服务项和物流项不能同时低于同行1.3%；
            						                       ??d、淘宝店铺，描述、服务、物流三项不能同时低于同行0.8%；
            						    				                       淘宝店铺需满足：
            						    				                       两个以上飘红
            						                       */
            						                       console.log(shop.type);
            						                       if(shop.type=="B"){
            							                       if(evaluates[0].level<1){
            							                    	   if(score[0].highGap*1<-8.8){
            							                    		   msg[0]="低于同行1.86%";
            							                    	   		error[0]=status[1];
            							                    	   		//err=true;
            								                    	   }else if(score[0].highGap<-8.2){
            																if(volume<300){
            																	msg[0]="低于同行1.2%,销量必须≥300";
            										                    	   	error[0]=status[1];
            										                    	   	//err=true;
            																	}
            									                    	   }
            								                       	}
            							                       if(evaluates[1].level<1){
            							                    	   if(score[1].highGap*1<-8.3&&score[2].highGap*1<-8.3){
            							                    		   msg[1]="服务项和物流项不<br>能同时低于同行1.3%";
            							                    	   		error[1]=status[1];
            							                    	   		//err=true;
            								                    	   }
            								                       }
            							                       if(evaluates[2].level<1){
            							                    	   if(score[1].highGap*1<-8.3&&score[2].highGap*1<-8.3){
            							                    		   msg[2]="服务项和物流项不<br>能同时低于同行1.3%";
            							                    	   		error[2]=status[1];
            							                    	   		//err=true;
            								                    	   }
            								                       }
            							                       
            								                     }else{
            								                    	 if(!isau){
            								                    		 if(score[0].highGap*1<-8.8&&score[1].highGap*1<-8.8&&score[2].highGap*1<-8.8){
              								                    		   if(score[2].highGap<-1.3){
              								                    			   msg[0]="淘宝店铺，描述、服务、物流<br>三项不能同时低于同行0.8%";
              									                    	   		error[0]=status[1];
              									                    	   		//err=true;
              									                    	   }
              									                    }
              								                    	 if(evaluates[0].level*1+evaluates[1].level*1+evaluates[2].level*1<=-1){
              								                    		 msg[1]="两个以上飘红";
              								                    	   		error[1]=status[1];
              								                    	   		//err=true;
              									                     }
            								                    	 }
            								                    	
            									                     
            									                   }
            						                    	   
            						                       for(var x in evaluates){
            							                       var v=evaluates[x],l=1+v.level*1,s=Math.abs(score[x].highGap);
            							                       s=(l==1)?"----":s+"%";
            							                       console.log(x+"=="+l+" "+s)
            						                    	   str+='<tr>'+(x==0?lanmu:"")+'<td>'+v.title+': '+v.score+' <span> '+level[l]+'</span> <a> '+level_text[l]+' </a><span> '+s+' </span></td><td>'+msg[x]+'</td><td align="center">'+error[x]+'</td></tr>';
            							                       }
            						                       if(shop.type=="B"){
            						                    	   $.ajax({url:"https://dsr-rate.tmall.com/list_dsr_info.htm?itemId="+itemid,
                  	        						                dataType:'jsonp',
                  	        						                success:function(result) {
                  	        						                	if(result.gradeAvg*1<8.6){
                  	        						                		//err=true;
                         						                    	   str+="<tr><th>天猫4.6分以上</th><td>"+result.gradeAvg+"</td><td>天猫店评分≥4.6</td><td align='center'>"+status[1]+"</td></tr>";
                  	        						                	}
                  	        						                	showErrMsg();
                  	        						                }
                   						                       });
            						                       }else{
            						                    	   $.ajax({url:"https://rate.taobao.com/detailCommon.htm?auctionNumId="+itemid+"&userNumId="+seller.userNumId+"&ua=098%23E1hvGQvRvcvvUvCkvvvvvjiPP25ZljDRPssZtjrCPmPOsjnmRFFh6jtURsMW0jEjrQhvCIkEkO5O2OhCvv14c49vVn147DuO8YGCvpvVvmvvvhCvUphv9Okgkwpm2SAW%2FGVekpWRqOme6KkjMPS5AJKhtW%2B22K0vi%2BqYyny2qnVYkfun6nRT9qen%2BOvm2SAW%2Bi0ezQWngUMYeJkVAPz5kuNRtgPMhuNRtIb%2BDWy2tIbrD4f7mPSD98NpgOpWMTNVtINy9wy2%2FtdY6S57AG53yKewiiNUvSABtbyCvm9vvvvvphvvvvvv96CvpvBRvvm2phCvhRvvvUnvphvppvvv96CvpCCvuphvmvvv9mMEEkdPkphvC99vvOClBpyCvhQhip6vCsAn3w0xhE36L%2Bex6aZtn0vHfaClYb8rame%2Bk2z3hBOyVaF9tW97RAYVyO2vqbVQWl4v1nLIRfU6pwet9EVJ%2B3%2BuaNsOAEkf2QhvC26wT9ytvpvhvvvvv8wCvvpvvUmm3QhvCvvhvvmrvpvEvvATv6rbvRLYRphvCvvvvvv%3D",
                 	        						                dataType:'jsonp',
                 	        						                success:function(result) {
                 	        						                	console.log(result);
                 	        						                	if(result.data.count.goodFull*1<1){
                 	        						                		//err=true;
                        						                    	   str+="<tr><th>月好评</th><td>"+result.data.count.goodFull+"</td><td>C店月好评≥100</td><td align='center'>"+status[1]+"</td></tr>";
                 	        						                	}
                 	        						                	showErrMsg();
                 	        						                }
                  						                       });
            						                    	   
            						                       }
            						                       function showErrMsg(){
            						                    	   if(err){
                						                    	   str+='</tbody></table>';
                						                    	   layer.open({
                    						                           type: 1,
                    						                           title: "商品不符合要求 不能提交",
                    						                           closeBtn: 0,
                    						                           offset:["23%","40%"],
                    						                           area: '550px',
                    						                           skin: 'layui-layer-shenhe', //没有背景色
                    						                           shadeClose: true,
                    						                           content: str,
                    						                           end:function(){
        	              						                        	window.location.reload();
        	              						                         }
                    						                       }); 
                						                       }
            						                       }
            						                       
            						                       
            						                    }else{
            						                        layer.msg("宝贝数据调用失败，原因："+result.ret[0],{time: 3000, icon:3});
            						                    }
            						                }
            						            });
            									
            								}
            									
            									
            									 if(getjsInfo){
            		                  				 //用js来获取商品的信息
            		                  				 var inf=data.itemInfoModel;
            		                  				 var serll=data.seller;
            		                  				setItemInfo({title:inf.title,citem:inf.picsPath,nick:serll.nick,num_iid:inf.itemId,sellerId:serll.userNumId,type:serll.type,pic_url:inf.picsPath[1]});
            		                  			 }
            									
            									var price=v.data.itemInfoModel.priceUnits[0].price;
            									var pstr=price;
            									console.log(price)
            									if(price.indexOf("-")>=0){
            										price=price.split("-");
            										var coupon_price=$("#coupon_price").val(price[0]);
            										$("<label for='price1'><input type='radio' id='price1' name='coupon_price_check' checked='checked' value='"+price[0]+"'>"+price[0]+"</label>&nbsp;&nbsp;&nbsp;&nbsp;<label for='price1'><input type='radio' id='price1' name='coupon_price_check'  value='"+price[1]+"'>"+price[1]+"</label>")
            										.insertAfter(coupon_price).find("input").click(function(){
            											coupon_price.val($(this).val());
            											});
            										
            										}else{
            											console.log("price="+price)
            											var coupon_price=$("#coupon_price").val(price);
                										$("<label for='price1'><input type='radio' id='price1' name='coupon_price_check' checked='checked' value='"+price+"'>"+price+"</label>")
                										.insertAfter(coupon_price).find("input").click(function(){
                											coupon_price.val($(this).val());
                											});
            										}
            									
            									}
            								}
            							
            							
            							
            						}
                  		}
                       }
    				});
          }
           
      }else{
         layer.msg("下单地址格式不正确！",{time: 3000, icon:2});
          $('#clickurl').val('');
      }
}
    //解析优惠券链接
    //-------------------------------------------------------------------
    var couponslink=$('#couponslink').on('input',function(){
    	getyhqdesc();

    });
function getyhqdesc(){
	if(!$("#num_iid").val()){
		layer.msg("请先输入宝贝链接在放优惠券",{time: 3000, icon:3});
		couponslink.val('');return;
	}
    var result = checkeCouponURL($('#couponslink').val());
    console.log(result);
    if(result[0]){
    	//根据优惠券店铺名和宝贝店铺名判断优惠券是否正确
    	if(nick){
    		console.log(nick+"=="+result[1])
    		if(nick!=result[1]){
    			layer.msg("优惠券店铺名和宝贝店铺名不相符",{time: 3000, icon:3});
    			couponslink.val('');return;
    		}
    	}else{
     		nick=result[1];
     		console.log(nick);
     	}
    	var index = layer.load(0, {shade: false}); 
        $.getJSON('http://a.yishoudan.com/index.php?callback=?&m=itemsf&a=ajax_yhj',{'itemid':$("#num_iid").val(),'activityId':result[2]},function(r){
        	layer.close(index);
            if(r.status == 1){
            	var data=r.data;
            	var price = $("#coupon_price").val()*1;
            	data.info1*=1;
           	 couponslink.focus();
            	console.log(data);
                if(quanOld&&quanOld>data.quan){
                	couponslink.val('').focus();
            		layer.msg("优惠劵满金额过小<"+quanOld,{time: 3000, icon:7});
            		return;
                }
            	if(price<data.info1){
            		couponslink.val('').focus();
            		layer.msg("优惠劵满("+data.info1+"可用 大于 商品价"+price+")不符合当前产品价格使用",{time: 3000, icon:7});
            		return;
            	}
            
                var now = Date.parse(new Date())/1000;
                if(data.endtime < now){
                	data.info1=-1;
//                    layer.msg("优惠券已过期或者本券不支持二合一券！请手动输入"+data.endtime,{time: 3500, icon:7});
//                    return false;
                }
                if(data.starttime<=now){
                    $('#my-startDate').text(new Date((now+8*3600) * 1000).toISOString().substr(0,10));
                    $('#start_time').val(new Date(new Date().toLocaleDateString()).getTime()/1000);
                }else{
                    $('#my-startDate').text(data.date1);
                    $('#start_time').val(data.starttime);
                }

                $('#couponstarttime').val(data.starttime);
                $('#my-endDate').text(data.date2);
                $('#end_time').val(data.endtime);
                $('#couponendtime').val(data.endtime);

                $('#couponslink').val('http://shop.m.taobao.com/shop/coupon.htm?sellerId='+result[1]+'&activityId='+result[2])
                $('#sellerId').val(result[1]);
                $('#activityId').val(result[2]);
                $('#coupons').val(data.quan);
                $("#info1").val(data.info1);
                $("#info2").val(data.info2);
                $("#date1").val(data.date1);
                $("#date2").val(data.date2);
                $('#couponreceive').val(data.count);
                $('#couponsurplus').val(data.rest);
                $('#single_sum').val("单笔满"+data.info1+"元可用");
                $('#single_sum').attr('data-sum',data.info1);
               
                //需要结算
                var needscore=$('#add_sub').attr('data-score');
                var base_score=$('#add_sub').attr('data-base');
                var is_open=$('#add_sub').attr('data-open');
                var couponsurplus=$.trim($('#couponsurplus').val());
                var accounts_base=base_score*couponsurplus/2;

                var score=Math.round(accounts_base) + parseInt(needscore);
                if(base_score>0 && is_open==1){
                    $('.expend').text(score);
                }
                validateTime();
//                $("#yhqInfo").show(500);
                $("#info1").focus();
                changeTpl();
            }else{
            	// layer.msg("优惠券过期或失效或者本券不支持二合一券！",{time: 3000, icon:7});couponslink.val('');
            	 //return;
            }
		});

    }else{

        layer.msg("无法解析该优惠券链接！",{time: 3000, icon:2});
        couponslink.val('');
        return;

    }
}
    //时间选择
    //-------------------------------------------------------------------
    var nowTemp = new Date();
    var nowDay = new Date(nowTemp.getFullYear(), nowTemp.getMonth(), nowTemp.getDate(), 0, 0, 0, 0).valueOf();
    var nowMoth = new Date(nowTemp.getFullYear(), nowTemp.getMonth(), 1, 0, 0, 0, 0).valueOf();
    var nowYear = new Date(nowTemp.getFullYear(), 0, 1, 0, 0, 0, 0).valueOf();

    var startDate = nowTemp;
    var endDate = new Date(2099,1,1);
    var today = new Date(new Date().toDateString()).getTime();

    $('#my-start').datepicker({
        onRender: function(date, viewMode) {
            var viewDate = nowDay;
            switch (viewMode) {
                case 1:
                    viewDate = nowMoth;
                    break;
                case 2:
                    viewDate = nowYear;
                    break;
            }
            return date.valueOf() < viewDate ? 'am-disabled' : '';
        }
    }).on('changeDate.datepicker.amui', function(event) {
        var couponstarttime=$('#couponstarttime').val();
        if (event.date.valueOf() > endDate.valueOf()) {
//            layer.msg("开始日期应小于结束日期！");
        } else if(event.date.valueOf() < couponstarttime*1000){
//            layer.msg("开始日期应不小于优惠券开始日期！");
        }else {
            startDate = new Date(event.date);
            $('#my-startDate').text($('#my-start').data('date'));
            $('#start_time').val(startDate.getTime()/1000);
        }
        if(startDate.getTime() > today){
            $('#uptime').children(":first").val(0);
        }

        $(this).datepicker('close');
    });

    $('#my-end').datepicker({
        onRender: function(date, viewMode) {
            var viewDate = nowDay;
            switch (viewMode) {
                case 1:
                    viewDate = nowMoth;
                    break;
                case 2:
                    viewDate = nowYear;
                    break;
            }
            return date.valueOf() < viewDate ? 'am-disabled' : '';
        }
    }).on('changeDate.datepicker.amui', function(event) {
        startDate = new Date(event.date);
        var couponendtime=$('#couponendtime').val();
        if (event.date.valueOf() < startDate.valueOf()) {
//            layer.msg("结束日期应大于开始日期！");
        } else if(event.date.valueOf() > couponendtime*1000){
//            layer.msg("结束日期应不大于优惠券结束日期！");
        }else{
            endDate = new Date(event.date);
            $('#my-endDate').text($('#my-end').data('date'));
            $('#end_time').val((endDate.getTime()/1000)+86399);
        }
        $(this).datepicker('close');
    });
    //表单提交AJAX化
    //-------------------------------------------------------------------
   var from= $('#form').Validform({
   
    	btnSubmit:"#add_sub",
    	tiptype:function(msg){
    		console.log(msg);
			layer.msg(msg);
		},
    	postonce:true,
    	ajaxPost:true,
    	tipSweep:true,
    	beforeSubmit:function(){
    		$("#add_sub").attr('disabled',"disabled");
    	},
    	callback:function(d){
    		if(d.status==1){
    			if($("input[name='id']").length>0){
    				layer.msg(d.msg,{time: 3000, icon:6});
    				location.href="/index/index/manage.html";
    			}else{
    				 layer.msg(d.msg,{time: 3000, icon:6}, function(){
    					 location.href="/index/index/manage.html";
                	 });
    			}
    		}else if(d.status==-1){
    			layer.msg(d.msg,{time: 3000, icon:6});
				location.href="/index/index/manage.html";
    		}else if(d.status==-2){
    			$("#add_sub").removeAttr('disabled');
    			var width=1200,height=750;
    			var left=($(window.parent).width()-width)/2,top=($(window.parent).height()-height)/2;
    			layer.confirm(d.msg+'，请续费<br><center>到期时间【'+d.data+'】</center>', {
                    offset: ['35%', '35%'],
                    btn: ['<span onclick=\'window.open("http:\/\/a.yishoudan.com\/other\/chongzhi","_blank","toolbar=yes, location=yes, directories=no, status=no, menubar=yes, scrollbars=yes, resizable=no, copyhistory=yes,left='+left+',top='+top+' width='+width+', height='+height+'")\'>立即充值<\/span>', '取消'] //按钮
                }, function () {
                	var index=layer.alert('我已经充值成功，点击确定继续发布', {
                		 offset: ['35%', '35%'],
                		  icon: 3,
                		  skin: 'layer-ext-moon' 
                		},function(index){
                			from.submitForm();
                			  layer.close(index);
                			})
                }, function () {
                });
    		}
    	}
    });
   var jihuap=$("#jihuap"),RateMap=$("#jhtype2");
   RateMap.click(function(){
	   jihuap.show('1000');
   
   });
   $("#jhtype1,#jhtype3").change(function(){
   	jihuap.hide('1000');
   });
   var start_time_item=$("#start_time_item");
   $("#showTime").on("change","label",function(){
	   var o=$(this);
	   switch(o.index())
	   {
	   case 1:
		   start_time_item.show();
	     break;
	   default:
		   start_time_item.hide();
	   }
   });
   var start_11_item=$("#start_11_item");
   $("#act_type").on("change","label",function(){
	   var o=$(this);
	   switch(o.index())
	   {
	   case 3:
		   start_11_item.show();
		   $("#showTime label:eq(1)").click();
	     break;
	   default:
		   start_11_item.hide();
	   }
   });
   //定向计划链接提取 id
   $("#jihualink").on("input",function(){
	   var str=$(this).val();
	   var campaignid = str.match("[?&](campaignId)=(\\d+)");
	   var shopkeeperid = str.match("[?&](shopkeeperId)=(\\d+)");
	   console.log(campaignid);
	   console.log(shopkeeperid);
	   if(campaignid&&campaignid[2])$("#campaignid").val(campaignid[2]);
	   if(shopkeeperid&&shopkeeperid[2])$("#shopkeeperid").val(shopkeeperid[2]);
   });
    //下单地址判断
    $('#clickurl').blur(function(){
        var preg=/http(s)?:/;
        if($.trim($('#clickurl').val()).match(preg)==null){
            layer.msg('宝贝链接格式不正确');
        }
    });
    
    //下单地址判断
    $('#domian').blur(function(){
        var preg=/http(s)?:/;
        if($.trim($('#domian').val()).match(preg)==null){
        	$('#domian').val('');
            layer.msg('网站域名格式不正确');
        }
    });
    //pid判断
    $('#cmspid').blur(function(){
        var preg=/mm_/;
        if($.trim($('#cmspid').val()).match(preg)==null){
            $('#cmspid').val('');
            layer.msg('pid格式不正确');
        }
    });
    //字数限制
    $('#guide_article').keyup(function(){
        var reasonLen = $(this).val().length;
        $('.reason,.reasonBreak').hide();
        if(reasonLen <= 100){
            $('.reason').show();
            $('.reason .limit').text(100-parseInt(reasonLen));
        }
        if(reasonLen > 100){
            $('.reasonBreak').show();
            $('.reasonBreak .limit').text(parseInt(reasonLen)-100);
        }

    });

    //图片上传

    //-------------------------------------------------------------------
    var client = new OSS.Wrapper({
        region: 'oss-cn-shanghai',
        accessKeyId: 'n1UGdUThefPYWGtj',
        accessKeySecret: '760I4sLKiDbhIfvzz48mtqavVEHud6',
        bucket: 'yishoudan'
      });
    
    $('#share_image').on('change',function(e){
        var file = $(this)[0].files[0];
        var today = Math.round(new Date().getTime()/1000);
        if (file.type.indexOf("image") == 0) {
            if (file.size >= 5120000) {
                layer.msg("图片大小过大，应小于5M！");
                return
            }
        } else {
           layer.msg("您选择的不是图片哦！");
            return;
        }
//        $('#plus_image').html('<div class="copyimagebox am-text-center" style="line-height: 100px;position: relative;margin-bottom:0;border:1px solid #ccc;width: 100px;height:100px;"><i class="am-icon-spinner am-icon-spin"></i></div>');
        var key='wntk'+'_'+today;
        var storeAs = 'sjchangtu/'+key+file.name;
        var index = layer.load(0, {shade: false}); 
        client.multipartUpload(storeAs, file).then(function (result) {
        	layer.close(index);
        	var src='http://img.wntaoke.com/'+storeAs
//        	$('#plus_image').html('<div class="copyimagebox" style="position: relative;margin-bottom:0;border:1px solid #ccc;"><img class="imageshare" src="'+src+'"  style="max-width: 310px;"><div class="uploading" style="width:100%;"><i class="image_del_i am-text-center am-inline-block"></i></div></div>');

        	$('#copyimage').val(src);
            $('#tuiguangImg').attr("src",src);
        	layer.msg("图片上传成功！",{time: 3000, icon:1});
            $("#tuig_img1").show(500);
            changeTpl();
        }).catch(function (err) {
        	layer.close(index);
          console.log(err);
        });
    });
    
    $('#yanhuo_image').on('change',function(e){
        var file = $(this)[0].files[0];
        var today = Math.round(new Date().getTime()/1000);
        if (file.type.indexOf("image") == 0) {
            if (file.size >= 5120000) {
                layer.msg("图片大小过大，应小于5M！");
                return
            }
        } else {
           layer.msg("您选择的不是图片哦！");
            return;
        }
//        $('#plus_image').html('<div class="copyimagebox am-text-center" style="line-height: 100px;position: relative;margin-bottom:0;border:1px solid #ccc;width: 100px;height:100px;"><i class="am-icon-spinner am-icon-spin"></i></div>');
        var key='wntk'+'_'+today;
        var storeAs = 'yanhuo/'+$("#num_iid").val()+".jpg";
        var index = layer.load(0, {shade: false}); 
        client.multipartUpload(storeAs, file).then(function (result) {
        	layer.close(index);
        	var src='http://img.wntaoke.com/'+storeAs
//        	$('#plus_image').html('<div class="copyimagebox" style="position: relative;margin-bottom:0;border:1px solid #ccc;"><img class="imageshare" src="'+src+'"  style="max-width: 310px;"><div class="uploading" style="width:100%;"><i class="image_del_i am-text-center am-inline-block"></i></div></div>');

        	$('#yanhuoimage').val(src);
            $('#yanhuoImg').attr("src",src);
        	layer.msg("图片上传成功！",{time: 3000, icon:1});
            $("#tuig_img2").show(500);
        }).catch(function (err) {
        	layer.close(index);
          console.log(err);
        });
    });

    $("#isyishou").click(function(){
    	 var result = checkeCouponURL(couponslink.val());
         if(result[0]){
        	 if($("#couponreceive").val()<10){
        		return ;
        	 }
         }
         layer.msg("您的优惠劵领取数量大等于10 不能选择一手单属性",{time: 3000, icon:7});
    	 $("#notYishou").click();
    	 couponslink.focus();
    });

    //活动时间
    $("input[name='time_type']").change(function (v) {
/*        startDate = new Date(event.date);
        $('#my-startDate').text($('#my-start').data('date'));
        $('#start_time').val(startDate.getTime()/1000);
        var couponstarttime=$('#couponstarttime').val();
        if(event.date.valueOf() < couponstarttime*1000){
            layer.msg("开始日期应不小于优惠券开始日期！",{time: 3000, icon:7});
        }*/
        if($(this).val()== 3)
            $("#time_toggle").show();
        else if($(this).val()==2){
            var start=new Date();
            start.setHours(0);
            start.setMinutes(0);
            start.setSeconds(0);
            start.setMilliseconds(0);
            var tommory=(Date.parse(start)/1000)+24*3600;
            $('#start_time').val(tommory);
            $("#time_toggle").hide();
        }else if($(this).val()==1){
            $('#start_time').val( (new Date()).valueOf()/1000);
            $("#time_toggle").hide();
        }
        validateTime();

    })
    //放大图片
    $("#pre_vi2").on("mouseover mouseout","img",function(event){
        if(event.type == "mouseover"){
            var imgo=$(this),src=imgo.attr('src');
            var offset=imgo.offset();
            offset.left+=92;offset.top-=250;

            if(!imgo.data('imgok')){
                console.log(offset)
                $('<img src="'+src+'" id="maxYulan" style="height:400px;">').appendTo('body').offset(offset).fadeIn();
                imgo.data('imgok',1);
            }else{
                $("#maxYulan").offset(offset).fadeIn();
            }
        }else{
            var imgo=$(this);imgo.data('imgok',null);
            $("#maxYulan").remove();
        }

    })


});
//活动时间和权时间对比
function validateTime(){
    // var type = $("input[name='time_type']:checked").val();
    var start_time = $('#start_time').val();
    var coupon_start_time = $('#couponstarttime').val();
    if(coupon_start_time && coupon_start_time>start_time){
//        layer.msg("开始日期应不小于优惠券开始日期！",{time: 3000, icon:7});
    }
}
function imgupload(e) {
    var clients = new OSS.Wrapper({
        region: 'oss-cn-shanghai',
        accessKeyId: 'n1UGdUThefPYWGtj',
        accessKeySecret: '760I4sLKiDbhIfvzz48mtqavVEHud6',
        bucket: 'yishoudan'
    });
    var dataid =  $(e).attr('data-name');
    var w =  $(e).attr('data-w');
    var h =  $(e).attr('data-h');
    var file = $(e)[0].files[0];
    var today = Math.round(new Date().getTime()/1000);
    if (file.type.indexOf("image") == 0) {

        var _URL = window.URL || window.webkitURL;
                var src = _URL.createObjectURL(file);
                $("<img src='"+src+"'>").load(function(){


                    $('#plus_image').html('<div class="copyimagebox am-text-center" style="line-height: 100px;position: relative;margin-bottom:0;border:1px solid #ccc;width: 100px;height:100px;"><i class="am-icon-spinner am-icon-spin"></i></div>');
                    var key='wntk'+'_'+today;
                    var storeAs = 'sjchangtu/'+key+file.name;
                    var index = layer.load(0, {shade: false});
                    clients.multipartUpload(storeAs, file).then(function (result) {
                        layer.close(index);
                        var src='http://img.wntaoke.com/'+storeAs
                        $('#plus_image').html('<div class="copyimagebox" style="position: relative;margin-bottom:0;border:1px solid #ccc;"><img class="imageshare" src="'+src+'"  style="max-width: 310px;"><div class="uploading" style="width:100%;"><i class="image_del_i am-text-center am-inline-block"></i></div></div>');
                        $('#'+dataid).val(src);
                        layer.msg("图片上传成功！",{time: 3000, icon:6});
                    }).catch(function (err) {
                        layer.close(index);
                        console.log(err);
                    });

                });

        if (file.size >= 5120000) {
            layer.msg("图片大小过大，应小于5M！");
            return
        }
    } else {

        layer.msg("您选择的不是图片哦！");

        return
    }

}


//各种方法
//判断是否一手单
//-------------------------------------------------------------------
function setItemInfo(d){
	d.id&&$("#itemid").val(d.id);
	$("#title").val(d.title);
	if(wenanOldTitle)d.oldtitle=wenanOldTitle;
	if(wenanIntro)d.intro=wenanIntro;
	$("#shorttitle").val(d.oldtitle);
	$("#nick").val(d.nick);
	var coupons=$("#coupons");
	$("#coupon_price").val(d.coupon_price);
	$("#commission_rate").val(d.commission_rate);
	$("#commission").val(d.commission);
	$("#num_iid").val(d.num_iid);
	$("#desc").val(d.desc);
	if(d.quan)quanOld = d.quan;
	d.gtype&&$("#jhpar .am-radio:eq("+(d.gtype-1)+")").click();
	d.campaignid&&$("#campaignid").val(d.campaignid);
	d.shopkeeperid&&$("#shopkeeperid").val(d.shopkeeperid);
	var color_upload=$("#color_upload").val(d.citem[0]);
      var noon1 = document.getElementById("noon1");
      noon.style.display="block";
      noon1.style.display="block";
      noon2.style.display="block";
      noon3.style.display="block";
      noon4.style.display="block";
      noon5.style.display="block";
	$str='<img src="' + d.pic_url + '"  width="100" height="100" />';
	$(d.citem).each(function(i,v){
		var classs='';
		if(i==0){
			classs="class='checkedimg'";
		}
		$str+='<img src="' + v + '" '+classs+' width="100" height="100"/>';
	});
	$("#pre_vi").html($str).find("img").click(function(){
		var o=$(this);
		if(o.hasClass("checkedimg"))return;
		color_upload.val(this.src);
		changeTpl();
		o.addClass("checkedimg").siblings().removeClass("checkedimg");
	});
	
	$("#price").val(d.price);
	
	$("#sellerId").val(d.sellerId);
	$("#tags").val(d.tags);
	$("#shop_type").val(d.type);
	if(isziji==2){
		$("#volume").val(d.volume);
		$("#initVolume").val(d.volume);
	}
	
	$("#yanhuobody").show(1000);
	$("#guide_article").val(d.intro);
	//历史短标题
    if(d.history_old_titles&&d.history_old_titles.length>0){
        var tmp_option = '',shorttitle=$("#shorttitle");
        $(d.history_old_titles).each(function(index,value){
         	var sl='';
         	value=value.oldtitle;
         	if(index==0){
         		sl='selected';
         		shorttitle.val(d.oldtitle?d.oldtitle:value);
         	}
             tmp_option += '<option value="'+value+'" '+sl+' >'+value+'</option>';
         });
    	 
         var selTitle=$("#selTitle");
         selTitle.html(tmp_option);
         form.render('select');
         form.on('select(title)', function(data){
        	  shorttitle.val(data.value);
           	changeTpl();
        	});      
         $("#selTitleDiv").show(500);
       
      
    }
    
    if(d.history_old_intro&&d.history_old_intro.length>0){
    	$("#guide_article").val(d.intro?d.intro:d.history_old_intro[0].intro);
    }else{
    	$("#guide_article").val(d.intro);
    }
    changeTpl();
    //历史长图
    var tmp_pic = '';
    $(d.rectangle_pics).each(function(index,value){
    	var sl='',src="http://img.wntaoke.com/history/"+value;
    	if(index==0){
    		sl='checkedimg';
    		$("#copyimage").val(wenanImg?wenanImg:src);
    		src=wenanImg?wenanImg:src;
    	}
        tmp_pic += '<img src="'+src+'" height="100" class="'+sl+'">';
    });
    if(!d.rectangle_pics&&wenanImg){
    	$("#copyimage").val(wenanImg);
    	tmp_pic='<img src="'+wenanImg+'" height="100" class="checkedimg">';
    }
    $("#pre_vi2").html(tmp_pic).on('click','img',function(){
        var o=$(this);
        if(o.hasClass("checkedimg"))return;
        $("#copyimage").val(this.src);
        changeTpl();
        o.addClass("checkedimg").siblings().removeClass("checkedimg");
    });
    // rectangle_pics   pre_vi2


}
function checkeCouponURL(str){

    var sellerId ='';
    var activityId = '';
    try{
	var reg1=/[?&](sellerId|seller_id)=(\d+)/m;
	var reg2=/[?&](activityId|activity_id)=(\w+)/m;
        sellerId = str.match(reg1)[2];
		
        activityId = str.match(reg2)[2];
    }catch(e){}

    if(sellerId != '' && activityId != ''){
        return new Array(true,sellerId,activityId);
    }else{
        return new Array(false);
    }

}

function removeimg(){
    $("#allimagebox").hide();
    $('.fileInputContainer').show();
    $("#addimage").replaceWith($("#addimage").clone(true));
}


function getiteminfo(itemid){
    $.ajax({url:"https://api.m.taobao.com/h5/mtop.taobao.detail.getdetail/6.0/?&api=mtop.taobao.detail.getdetail&v=6.0&ttid=2013%40taobao_h5_1.0.0&type=jsonp&dataType=jsonp&data=%7B%22itemNumId%22%3A%22"+itemid+"%22%7D",
        dataType:'jsonp',
        jsonp:'callback',
        success:function(result) {

            //console.log(JSON.parse(result.data.apiStack[0].value).price.price.priceText);

            if(result.ret[0] == "SUCCESS::调用成功"){
                $('#interaction').addClass('am-hide');
                if(result.data.params.trackParams.BC_type!='B'){
                    $('#clickurl').val('');
                   layer.msg("平台仅支持天猫B店！");
                   
                    return
                }
                if($.trim(JSON.parse(result.data.apiStack[0].value).item.sellCount)<10){
                    $('#clickurl').val('');
                   layer.msg("该宝贝月销量低于10，暂不支持发布！");
                   
                    return
                }
                $('#clickurl').val("https://detail.tmall.com/item.htm?id="+itemid);
                var desc_score=$.trim(result.data.seller.evaluates[0].score);
                var serv_score=$.trim(result.data.seller.evaluates[1].score);
                var post_score=$.trim(result.data.seller.evaluates[2].score);
                if(desc_score<8.7 && serv_score<8.7 && post_score<8.7){
                    $('#clickurl').val('');
                   layer.msg("该宝贝的动态评分过低！");
                   
                    return
                }
                $("#shoptype").val(result.data.params.trackParams.BC_type);
                $('.item_show').show();
                var price = JSON.parse(result.data.apiStack[0].value).price.price.priceText;
                if(price.indexOf("-") == -1){
                    $("#price").val(price);
                }
                $("#title").val(result.data.item.title);
                $("#shoptype").val(result.data.params.trackParams.BC_type);
                //判定是否为品牌
                $("#recommended").val(result.data.item.subtitle);
                $("#sales").val(JSON.parse(result.data.apiStack[0].value).item.sellCount);
                var add_image = "http:"+result.data.item.images[1];
                $("#image").val(add_image);
                api_getcopyimage(add_image,itemid);
                var len=result.data.item.images.length;
                var image=new Array();
                var taobao_image=new Array();
                for(var i=0;i<len;i++){
                    image[i]='<div class="am-align-left" style="position: relative;margin-bottom:0;"><img class="imagearry" src="http:'+result.data.item.images[i]+'_310x310.jpg" data-src="http:'+result.data.item.images[i]+'" style="width: 100px;height:100px;"><div class="selected_mask"><div class="selected_mask_icon"><i class="am-icon-check-square-o am-text-success am-text-xl"></i></div></div></div>';
                    taobao_image[i]="http:"+result.data.item.images[i];
                }
                var str_image=taobao_image.join(",");
                $('#taobao_image').val(str_image);
                $('.new_image').html('');
                $('.new_image').html(image);
                $("#shopid").val(result.data.seller.shopId);
                $("#userid").val(result.data.seller.userId);
                /*check_dynamic_scoring(result.data.seller.userId);*/
                $("#shopname").val(result.data.seller.shopName);
                $("#sellernick").val(result.data.seller.sellerNick);
                $('#imagegroup').removeClass('am-hide');
                $('.new_image').removeClass('am-hide');
                $('.select_pic').find('.imagearry').removeClass('selected_image');
                $('#allimagebox').addClass('am-hide');
                $(".new_image").children().eq(1).children(".selected_mask").show();
                $(".new_image").children().eq(1).children(".imagearry").addClass('selected_image');
                //设置类目
                getfqcat(result.data.item.categoryId);
                var brand_array=result.data.props.groupProps[0]['基本信息'];
                if(brand_array){
                    for (var i = brand_array.length - 1; i >= 0; i--){
                        for(var key in brand_array[i]){
                            if('品牌'==key){
                                var brand=brand_array[i][key];
                                break;
                            }
                        }
                    }
                    fqbrand(brand);
                }

            }else{
                layer.msg("宝贝数据调用失败，原因："+result.ret[0],{time: 3000, icon:3});
               
            }

        }
    });

}


//减法函数，用来得到精确的减法结果
//说明：javascript的减法结果会有误差，在两个浮点数相加的时候会比较明显。这个函数返回较为精确的减法结果。
//调用：accSubtr(arg1,arg2)
//返回值：arg1减去arg2的精确结果
function accSubtr(arg1,arg2){
    var r1,r2,m,n;
    try{r1=arg1.toString().split(".")[1].length}catch(e){r1=0}
    try{r2=arg2.toString().split(".")[1].length}catch(e){r2=0}
    m=Math.pow(10,Math.max(r1,r2));
    //动态控制精度长度
    n=(r1>=r2)?r1:r2;
    console.log(arg1+"-"+arg2+"="+(arg1-arg2))
    return ((arg1*m-arg2*m)/m).toFixed(n);
}
